name: QuantBot CI & Packaging
 
on: 
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
 
jobs:
  build-and-package:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ['3.11']
    steps:
    - uses: actions/checkout@v3
 
    - name: Install TA-Lib dependencies
      run: |
        choco install -y ta-lib --version=0.4.0.1
        echo "TA_LIBRARY_PATH=C:\Program Files\ta-lib\lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "TA_INCLUDE_PATH=C:\Program Files\ta-lib\include" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append 
 
    - name: Set up Python ${{ matrix.python-version  }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version  }}
 
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip 
        pip install numpy Cython TA-Lib 
        pip install -r requirements.txt  
        pip install pyinstaller
 
    - name: Package with PyInstaller
      run: |
        # 创建打包配置 
        $specContent = @"
# -*- mode: python -*-
block_cipher = None 
 
a = Analysis(
    ['main.py'], 
    binaries=[],
    datas=[],
    hiddenimports=[],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)
pyz = PYZ(a.pure,  a.zipped_data,  cipher=block_cipher)
exe = EXE(
    pyz,
    a.scripts, 
    a.binaries, 
    a.zipfiles, 
    a.datas, 
    [],
    name='QuantBot',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    upx_exclude=[],
    runtime_tmpdir=None,
    console=True,
    disable_windowed_tracker=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
)
"@ 
        $specContent | Out-File -FilePath build.spec  -Encoding utf8
 
        pyinstaller --noconfirm --onefile --windowed build.spec  
 
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: QuantBot-Windows 
        path: dist/QuantBot.exe 