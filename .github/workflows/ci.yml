name: QuantBot CI & Packaging
 
on: 
  push:
    branches: [main]
  pull_request:
    branches: [main]
 
jobs:
  build-and-package:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ['3.11']
    steps:
    - uses: actions/checkout@v4  # 也更新checkout到v4
 
    - name: Install TA-Lib dependencies
      run: |
        choco install -y ta-lib --version=0.4.0.1
        echo "TA_LIBRARY_PATH=C:\Program Files\ta-lib\lib" >> $env:GITHUB_ENV 
        echo "TA_INCLUDE_PATH=C:\Program Files\ta-lib\include" >> $env:GITHUB_ENV
 
    - name: Set up Python ${{ matrix.python-version  }}
      uses: actions/setup-python@v5  # 更新到最新版 
      with:
        python-version: ${{ matrix.python-version  }}
 
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip 
        pip install numpy Cython TA-Lib 
        pip install -r requirements.txt  
        pip install pyinstaller
 
    - name: Package with PyInstaller
      run: |
        # 生成精简版build.spec  
        echo "# -*- mode: python -*-" > build.spec 
        echo "a = Analysis(['main.py'],  binaries=[], datas=[])" >> build.spec  
        echo "exe = EXE(a.scripts,  name='QuantBot', console=True)" >> build.spec  
        pyinstaller --noconfirm --onefile --windowed build.spec  
 
    - name: Upload Windows executable 
      uses: actions/upload-artifact@v4  # 关键修复：升级到v4
      with:
        name: QuantBot-Windows 
        path: dist/QuantBot.exe 
        retention-days: 7  # 可选：设置制品保留天数 